; robot model meta-information
model_information {
  manipulatorModelType     1      // 0: Default-arm, 1: Wheel-based manipulator, 2: Floating-arm manipulator, 3: Fully actuated floating-arm manipulator
  
  ; motion joints in the URDF to consider fixed
  removeJoints {
    [0]  "fl_caster_rotation_joint"
    [1]  "fl_caster_l_wheel_joint"
    [2]  "fl_caster_r_wheel_joint"

    [3]  "fr_caster_rotation_joint"
    [4]  "fr_caster_l_wheel_joint"
    [5]  "fr_caster_r_wheel_joint"

    [6]  "bl_caster_rotation_joint"
    [7]  "bl_caster_l_wheel_joint"
    [8]  "bl_caster_r_wheel_joint"

    [9]  "br_caster_rotation_joint"
    [10] "br_caster_l_wheel_joint"
    [11] "br_caster_r_wheel_joint"

    [12] "head_pan_joint"
    [13] "head_tilt_joint"
    [14] "laser_tilt_mount_joint"

    [15] "r_gripper_motor_slider_joint"
    [16] "r_gripper_motor_screw_joint"
    [17] "r_gripper_l_finger_joint"
    [18] "r_gripper_r_finger_joint"
    [19] "r_gripper_l_finger_tip_joint"
    [20] "r_gripper_r_finger_tip_joint"
    [21] "r_gripper_joint"

    [22] "l_gripper_motor_slider_joint"
    [23] "l_gripper_motor_screw_joint"
    [24] "l_gripper_l_finger_joint"
    [25] "l_gripper_r_finger_joint"
    [26] "l_gripper_l_finger_tip_joint"
    [27] "l_gripper_r_finger_tip_joint"
    [28] "l_gripper_joint"

    [29] "torso_lift_motoxr_screw_joint"
  }

  ; base frame of the robot (from URDF)
  baseFrame                       "base_footprint"
  ; end-effector frame of the robot (from URDF) 
  eeFrame                         "l_gripper_tool_frame"
  eeFrame1                        "r_gripper_tool_frame"
}

model_settings
{
  usePreComputation               true
  recompileLibraries              true
}

; DDP settings
ddp
{
  algorithm                       SLQ

  nThreads                        3
  threadPriority                  50

  maxNumIterations                1
  minRelCost                      0.1
  constraintTolerance             1e-3

  displayInfo                     false
  displayShortSummary             false
  checkNumericalStability         false
  debugPrintRollout               false
  debugCaching                    false

  AbsTolODE                       1e-5
  RelTolODE                       1e-3
  maxNumStepsPerSecond            100000
  timeStep                        1e-3
  backwardPassIntegratorType      ODE45

  constraintPenaltyInitialValue   20.0
  constraintPenaltyIncreaseRate   2.0

  preComputeRiccatiTerms          true

  useFeedbackPolicy               true

  strategy                        LINE_SEARCH
  lineSearch
  {
    minStepLength                 1e-2
    maxStepLength                 1.0
    hessianCorrectionStrategy     DIAGONAL_SHIFT
    hessianCorrectionMultiple     1e-3
  }
}

; Rollout settings
rollout
{
  AbsTolODE                       1e-5
  RelTolODE                       1e-3
  timeStep                        1e-2
  integratorType                  ODE45
  maxNumStepsPerSecond            100000
  checkNumericalStability         false
}

; MPC settings
mpc
{
  timeHorizon                     2.0   ; [s] // 1.0, 2.0
  solutionTimeWindow              0.2   ; [s] // 0.2, 0.4, -1 maximum [s]
  coldStart                       false
  
  debugPrint                      false

  mpcDesiredFrequency             100   ; [Hz] // 80, 100, -1 (negative for best effort policy rollout!)
  mrtDesiredFrequency             250   ; [Hz] // 500
}


; SQP settings (multiple shooting)
sqp
{
  nThreads                              3
  dt                                    0.01
  sqpIteration                          1
  deltaTol                              1e-4
  costTol                               1e-4

  g_max                                 1e6
  g_min                                 1e-6
  inequalityConstraintMu                0.0
  inequalityConstraintDelta             1e-6

  projectStateInputEqualityConstraints  true
  useFeedbackPolicy                     true
  integratorType                        RK2

  printSolverStatistics                 true
  printSolverStatus                     false
  printLinesearch                       false

  logFilePath                           /tmp/ocs2/sqp_log/
}
; initial state
initialState
{
  ; initial state for the different types of arm base DOFs
  base
  {
    defaultManipulator
    {
    }

    floatingArmManipulator
    {
      (0,0)  0.0  ; position x
      (1,0)  0.0  ; position y
      (2,0)  0.5  ; position z
      (3,0)  0.0  ; euler angle z
      (4,0)  0.0  ; euler angle y
      (5,0)  1.7  ; euler angle x
    }

    fullyActuatedFloatingArmManipulator
    {
      (0,0)  0.0  ; position x
      (1,0)  0.0  ; position y
      (2,0)  0.0  ; position z
      (3,0)  0.0  ; euler angle z
      (4,0)  0.0  ; euler angle y
      (5,0)  0.0  ; euler angle x
    }

    wheelBasedMobileManipulator
    {
      (0,0)  -1.0  ; position x
      (1,0)  0.0  ; position y
      (2,0)  0.0  ; heading
    }
  }

  ; initial state for the arm DOFs
  arm
  {
    (0,0)   0.10       ; torso_lift_joint

    (1,0)   0.00       ; l_shoulder_pan_joint
    (2,0)   0.00     ; l_shoulder_lift_joint
    (3,0)   0.0     ; l_upper_arm_roll_joint
    (4,0)   0.0     ; l_elbow_flex_joint
    (5,0)   0.0     ; l_forearm_roll_joint
    (6,0)   0.0     ; l_wrist_flex_joint
    (7,0)   0.0     ; l_wrist_roll_joint

    (8,0)   0.00        ; r_shoulder_pan_joint
    (9,0)   0.00        ; r_shoulder_lift_joint
    (10,0)  0.0         ; r_upper_arm_roll_joint
    (11,0)  0.0      ; r_elbow_flex_joint
    (12,0)  0.0       ; r_forearm_roll_joint
    (13,0)  0.0      ; r_wrist_flex_joint
    (14,0)  0.0       ; r_wrist_roll_joint
  }
}

inputCost
{
  ; control weight matrix
  R
  {
    ; input costs for the different types of arm base DOFs
    base
    {
      defaultManipulator
      {
      }

      floatingArmManipulator
      {
      }

      fullyActuatedFloatingArmManipulator
      {
        scaling 1e-2
        (0,0)  5.0  ; position x
        (1,1)  5.0  ; position y
        (2,2)  5.0  ; position z
        (3,3)  5.0  ; euler angle z
        (4,4)  5.0  ; euler angle y
        (5,5)  5.0  ; euler angle x
      }

      wheelBasedMobileManipulator
      {
        scaling 1e-2
        (0,0)  1.5  ; forward velocity
        (1,1)  1.5  ; turning velocity
      }
    }
    
    ; input costs for the arm DOFs
    arm
    {
      scaling 1e-3

      (0,0)  1.0  ; torso_lift_joint velocity

      (1,1)  1.0  ; l_shoulder_pan_joint velocity
      (2,2)  1.0  ; l_shoulder_lift_joint velocity
      (3,3)  1.0  ; l_upper_arm_roll_joint velocity
      (4,4)  1.0  ; l_elbow_flex_joint velocity
      (5,5)  1.0  ; l_forearm_roll_joint velocity
      (6,6)  1.0  ; l_wrist_flex_joint velocity
      (7,7)  1.0  ; l_wrist_roll_joint velocity

      (8,8)  1.0    ; r_shoulder_pan_joint velocity
      (9,9)  1.0    ; r_shoulder_lift_joint velocity
      (10,10) 1.0   ; r_upper_arm_roll_joint velocity
      (11,11) 1.0   ; r_elbow_flex_joint velocity
      (12,12) 1.0   ; r_forearm_roll_joint velocity
      (13,13) 1.0   ; r_wrist_flex_joint velocity
      (14,14) 1.0   ; r_wrist_roll_joint velocity
    }
  }
}


jointTracking
{
  activate  true
  mu        20.0

  ; ARM ONLY reference (size = armDim)
  reference
  {
    (0,0)   0.10       ; torso_lift_joint

    (1,0)   0.00       ; l_shoulder_pan_joint
    (2,0)   0.00       ; l_shoulder_lift_joint
    (3,0)   0.00       ; l_upper_arm_roll_joint
    (4,0)   0.00       ; l_elbow_flex_joint
    (5,0)   0.00       ; l_forearm_roll_joint
    (6,0)   0.00       ; l_wrist_flex_joint
    (7,0)   0.00       ; l_wrist_roll_joint

    (8,0)   0.00       ; r_shoulder_pan_joint
    (9,0)   0.00       ; r_shoulder_lift_joint
    (10,0)  0.00       ; r_upper_arm_roll_joint
    (11,0)  0.00       ; r_elbow_flex_joint
    (12,0)  0.00       ; r_forearm_roll_joint
    (13,0)  0.00       ; r_wrist_flex_joint
    (14,0)  0.00       ; r_wrist_roll_joint
  }
}

baseTracking
{
  activate true
  mu  50.0

  reference
  {
    base
    {
      wheelBasedMobileManipulator
      {
        (0,0)  -1.0  ; x
        (1,0)  0.0   ; y
        (2,0)  0.0   ; yaw
      }

      floatingArmManipulator
      {
        (0,0)  0.0
        (1,0)  0.0
        (2,0)  0.0
        (3,0)  0.0  ; euler z
        (4,0)  0.0  ; euler y
        (5,0)  0.0  ; euler x
      }

    }
  }
}

endEffectorTracking
{
  activate          true
  dualArmMode      true
  leftArm
  {
    muPosition      10.0
    muOrientation    5.0
  }
  rightArm
  {
    muPosition      10.0
    muOrientation    5.0
  }
}

finalEndEffectorTracking
{
  activate          true
  dualArmMode      true
  leftArm
  {
    muPosition      10.0
    muOrientation    5.0
  }
  rightArm
  {
    muPosition      10.0
    muOrientation    5.0
  }
}

; Optional mode-based blending of tracking constraints (does not override the per-constraint `activate` flags).
; Weights are applied at runtime via the modeSchedule (modeAtTime(t)):
;   jointTracking residual is scaled by alphaJoint
;   baseTracking residual is scaled by alphaBase
;   endEffectorTracking residual is scaled by alphaEe
; If a constraint's `activate` is false, it is not added at all (always off).
referenceBlending
{
  normalize   true
  eps         1e-9

  default
  {
    alphaEe     0.0
    alphaBase   0.0
    alphaJoint  1.0
  }

  ; Each entry defines weights for a specific mode number.
  ; Two supported syntaxes:
  ;   [0] "mode alphaEe alphaBase alphaJoint"
  ;   [0] { mode 0 alphaEe 0 alphaBase 1 alphaJoint 0 }
  modeWeights
  {
    [0] "0  0.0  0.0  1.0"  ; joint-only
    [1] "1  1.0  0.0  0.0"  ; EE-only
    [2] "2  1.0  0.0  1.0"  ; joint + EE
    [3] "3  0.0  1.0  0.0"  ; base-only
    [4] "4  1.0  1.0  0.0"  ; base + EE
  }
}

selfCollision
{ 
  ; activate self-collision constraint
  activate  false // false; true

  ; Self Collision pairs
  collisionLinkPairs
  {
    [0] "l_forearm_link, r_forearm_link"
  }

  ; minimum distance allowed between the pairs
  minimumDistance  0.1

  ; relaxed log barrier mu
  mu     0.01

  ; relaxed log barrier delta
  delta  0.001
  
  ; TODO: Replace the collision meshes of the arm with primitive shapes.
}

; Only applied for arm joints: limits parsed from URDF
jointPositionLimits
{
  ; activate constraint
  activate  true

  ; relaxed log barrier mu
  mu      0.01

  ; relaxed log barrier delta
  delta   1e-3
}

jointVelocityLimits
{
  ; relaxed log barrier mu
  mu      0.01

  ; relaxed log barrier delta
  delta   1e-3

  lowerBound
  {
    ; velocity limits for the different types of arm base DOFs
    base
    {
      defaultManipulator
      {
      }

      floatingArmManipulator
      {
      }

      fullyActuatedFloatingArmManipulator
      {
        (0,0)  -0.1  ; linear velocity x
        (1,0)  -0.1  ; linear velocity y
        (2,0)  -0.1  ; linear velocity z
        (3,0)  -0.3  ; euler angle velocity z
        (4,0)  -0.3  ; euler angle velocity y
        (5,0)  -0.3  ; euler angle velocity x
      }

      wheelBasedMobileManipulator
      {
        (0,0)  -2.0 ; forward velocity
        (1,0)  -2.0 ; turning velocity
      }
    }

    ; velocity limits for the arm DOFs
    arm
    {
      (0,0)  -0.013    ; torso_lift_joint [m/s]

      (1,0)  -2.088    ; l_shoulder_pan_joint [rad/s]
      (2,0)  -2.082	   ; l_shoulder_lift_joint [rad/s]
      (3,0)  -3.270	   ; l_upper_arm_roll_joint [rad/s]
      (4,0)  -3.300	   ; l_elbow_flex_joint [rad/s]
      (5,0)  -3.599	   ; l_forearm_roll_joint [rad/s]
      (6,0)  -3.078	   ; l_wrist_flex_joint [rad/s]
      (7,0)  -3.599	   ; l_wrist_roll_joint [rad/s]

      (8,0)  -2.088         ; r_shoulder_pan_joint [rad/s]
      (9,0)  -2.082	        ; r_shoulder_lift_joint [rad/s]
      (10,0) -3.270	   ; r_upper_arm_roll_joint [rad/s]
      (11,0) -3.300	   ; r_elbow_flex_joint [rad/s]
      (12,0) -3.599	   ; r_forearm_roll_joint [rad/s]
      (13,0) -3.078	   ; r_wrist_flex_joint [rad/s]
      (14,0) -3.599	   ; r_wrist_roll_joint [rad/s]
    }
  }

  upperBound
  {
    ; velocity limits for the different types of arm base DOFs
    base
    {
      defaultManipulator
      {
      }

      floatingArmManipulator
      {
      }

      fullyActuatedFloatingArmManipulator
      {
        (0,0)  0.1  ; linear velocity x
        (1,0)  0.1  ; linear velocity y
        (2,0)  0.1  ; linear velocity z
        (3,0)  0.3  ; euler angle velocity z
        (4,0)  0.3  ; euler angle velocity y
        (5,0)  0.3  ; euler angle velocity x
      }

      wheelBasedMobileManipulator
      {
        (0,0)  2.0 ; forward velocity
        (1,0)  2.0 ; turning velocity
      }
    }

    ; velocity limits for the arm DOFs
    arm
    {
      (0,0)  0.013     ; torso_lift_joint [m/s]

      (1,0)  2.088     ; l_shoulder_pan_joint [rad/s]
      (2,0)  2.082	   ; l_shoulder_lift_joint [rad/s]
      (3,0)  3.270	   ; l_upper_arm_roll_joint [rad/s]
      (4,0)  3.300	   ; l_elbow_flex_joint [rad/s]
      (5,0)  3.599	   ; l_forearm_roll_joint [rad/s]
      (6,0)  3.078	   ; l_wrist_flex_joint [rad/s]
      (7,0)  3.599	   ; l_wrist_roll_joint [rad/s]

      (8,0)  2.088     ; r_shoulder_pan_joint [rad/s]
      (9,0)  2.082	   ; r_shoulder_lift_joint [rad/s]
      (10,0) 3.270	   ; r_upper_arm_roll_joint [rad/s]
      (11,0) 3.300	   ; r_elbow_flex_joint [rad/s]
      (12,0) 3.599	   ; r_forearm_roll_joint [rad/s]
      (13,0) 3.078	   ; r_wrist_flex_joint [rad/s]
      (14,0) 3.599	   ; r_wrist_roll_joint [rad/s]
    }
  }
}
